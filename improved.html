<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vital Decisions: Resident's Challenge</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f8;
            padding: 20px;
        }

        header {
            background-color: #005EB8;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        footer {
            background-color: #e7e7e7;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 8px 8px;
        }

        h1 {
            font-size: 1.8rem;
            margin: 0;
        }

        h2 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #005EB8;
            border-bottom: 2px solid #005EB8;
            padding-bottom: 5px;
        }

        /* Game container and panels */
        .game-container {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            height: calc(100vh - 140px);
        }

        .panel {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            background-color: #fafafa;
        }

        /* Vitals section */
        .vitals-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f0f5ff;
            border-radius: 5px;
            border: 1px solid #d0e0ff;
        }

        .vital-sign {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .vital-label {
            font-weight: bold;
            color: #444;
        }

        .vital-value {
            font-family: monospace;
            font-size: 1.1rem;
        }

        .vital-value.high {
            color: #d32f2f;
        }

        .vital-value.low {
            color: #1976d2;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-btn {
            background-color: #005EB8;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-grow: 1;
            min-width: 100px;
            text-align: center;
        }

        .action-btn:hover {
            background-color: #004C94;
        }

        .action-btn.active {
            background-color: #003A70;
        }

        /* Additional elements */
        .score-container {
            font-size: 1.2rem;
            font-weight: bold;
            background-color: #004C94;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .cost-container {
            font-size: 1.2rem;
            font-weight: bold;
            background-color: #2BAD60;
            padding: 5px 10px;
            border-radius: 4px;
            margin-left: 10px;
        }

        #new-patient-btn {
            background-color: #2BAD60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #new-patient-btn:hover {
            background-color: #1F9250;
        }

        .time-display {
            font-family: monospace;
            font-size: 1.2rem;
            background-color: #f0f0f0;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* Utility classes for result log entries */
        .log-entry {
            margin-bottom: a0px;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ccc;
        }

        .log-entry-normal {
            border-left-color: #2BAD60;
            background-color: #f0fff5;
        }

        .log-entry-abnormal {
            border-left-color: #f44336;
            background-color: #fff0f0;
        }

        .log-entry-info {
            border-left-color: #2196F3;
            background-color: #f0f8ff;
        }

        .timestamp {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 3px;
        }

        /* Action grids */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-option-btn {
            background-color: #e0e0e0;
            color: #333;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            text-align: left;
        }

        .action-option-btn:hover {
            background-color: #d0d0d0;
        }

        /* Lab categories */
        .lab-category, .medication-category {
            margin-bottom: 20px;
        }

        /* Medication form */
        .medication-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .primary-btn {
            background-color: #005EB8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .secondary-btn {
            background-color: #e0e0e0;
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Case type selector */
        .case-type-selector {
            display: flex;
            gap: 10px;
            margin-right: 15px;
        }

        .case-type-btn {
            background-color: #004C94;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }

        .case-type-btn:hover {
            background-color: #003A70;
        }

        .case-type-btn.active {
            background-color: #2BAD60;
        }

        /* Metrics display */
        .metrics-display {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Disable state */
        .disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header>
        <h1>Vital Decisions: Resident's Challenge</h1>
        <div class="metrics-display">
            <div class="score-container">Score: <span id="score">0</span></div>
            <div class="cost-container">API Cost: $<span id="api-cost">0.00</span></div>
        </div>
    </header>

    <main class="game-container">
        <section id="data-panel" class="panel">
            <h2>Patient Data</h2>
            <div id="patient-info" class="scrollable-content">
                <!-- Patient information will be populated here -->
                <p>No active patient. Select a case type and click "New Patient" to begin.</p>
            </div>
        </section>

        <section id="results-panel" class="panel">
            <h2>Results</h2>
            <div id="vitals" class="vitals-container">
                <div class="vital-sign">
                    <span class="vital-label">HR:</span>
                    <span id="heart-rate" class="vital-value">--</span>
                </div>
                <div class="vital-sign">
                    <span class="vital-label">BP:</span>
                    <span id="blood-pressure" class="vital-value">--/--</span>
                </div>
                <div class="vital-sign">
                    <span class="vital-label">MAP:</span>
                    <span id="mean-arterial-pressure" class="vital-value">--</span>
                </div>
                <div class="vital-sign">
                    <span class="vital-label">RR:</span>
                    <span id="respiratory-rate" class="vital-value">--</span>
                </div>
                <div class="vital-sign">
                    <span class="vital-label">Temp:</span>
                    <span id="temperature" class="vital-value">--</span>
                </div>
                <div class="vital-sign">
                    <span class="vital-label">O2 Sat:</span>
                    <span id="oxygen-saturation" class="vital-value">--</span>
                </div>
            </div>
            <div id="results-log" class="scrollable-content">
                <!-- Results from labs, patient updates, etc. will appear here -->
                <div class="log-entry log-entry-info">
                    <div class="timestamp">00:00</div>
                    <h3>Welcome</h3>
                    <div class="log-content">
                        <p>Welcome to Vital Decisions: Resident's Challenge! Select a case type and click "New Patient" to begin a new case.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="actions-panel" class="panel">
            <h2>Actions</h2>
            <div class="action-buttons">
                <button id="exam-btn" class="action-btn">Exam</button>
                <button id="labs-btn" class="action-btn">Labs</button>
                <button id="drugs-btn" class="action-btn">Drugs</button>
                <button id="imaging-btn" class="action-btn">Imaging</button>
                <button id="consult-btn" class="action-btn">Consult</button>
            </div>
            <div id="action-content" class="scrollable-content">
                <!-- Dynamic content based on selected action will appear here -->
                <p>Select an action to begin.</p>
            </div>
        </section>
    </main>

    <footer>
        <div class="case-type-selector">
            <button id="case-cardio" class="case-type-btn active">Cardiovascular</button>
            <button id="case-infectious" class="case-type-btn">Infectious</button>
            <button id="case-emergency" class="case-type-btn">Emergency</button>
            <button id="case-misc" class="case-type-btn">Miscellaneous</button>
        </div>
        <button id="new-patient-btn">New Patient</button>
        <div class="time-display">
            <span id="game-time">00:00</span>
        </div>
    </footer>

<script>
// Simulation mode - set to true to use mock data instead of API calls
const SIMULATION_MODE = false;

// Reference data for the game
const gameData = {
    // Normal ranges for common lab values
    labRanges: {
        // Complete Blood Count
        "WBC": { min: 4.5, max: 11.0, unit: "x10^9/L" },
        "RBC": { min: 4.5, max: 5.9, unit: "x10^12/L" },
        "Hemoglobin": { min: 13.5, max: 17.5, unit: "g/dL" },
        "Hematocrit": { min: 41, max: 53, unit: "%" },
        "Platelets": { min: 150, max: 450, unit: "x10^9/L" },
        
        // Basic Metabolic Panel
        "Sodium": { min: 135, max: 145, unit: "mmol/L" },
        "Potassium": { min: 3.5, max: 5.0, unit: "mmol/L" },
        "Chloride": { min: 96, max: 106, unit: "mmol/L" },
        "CO2": { min: 23, max: 29, unit: "mmol/L" },
        "BUN": { min: 7, max: 20, unit: "mg/dL" },
        "Creatinine": { min: 0.6, max: 1.2, unit: "mg/dL" },
        "Glucose": { min: 70, max: 100, unit: "mg/dL" },
        "Calcium": { min: 8.5, max: 10.5, unit: "mg/dL" },
        
        // Liver Function Tests
        "AST": { min: 5, max: 40, unit: "U/L" },
        "ALT": { min: 7, max: 56, unit: "U/L" },
        "ALP": { min: 44, max: 147, unit: "U/L" },
        "Total Bilirubin": { min: 0.1, max: 1.2, unit: "mg/dL" },
        "Direct Bilirubin": { min: 0.0, max: 0.3, unit: "mg/dL" },
        "Albumin": { min: 3.4, max: 5.4, unit: "g/dL" },
        "Total Protein": { min: 6.0, max: 8.3, unit: "g/dL" },
        
        // More categories omitted for brevity
    },
    
    // Available lab test categories
    labTests: {
        "Complete Blood Count": [
            "WBC", "RBC", "Hemoglobin", "Hematocrit", "Platelets", "Differential"
        ],
        "Basic Metabolic Panel": [
            "Sodium", "Potassium", "Chloride", "CO2", "BUN", "Creatinine", "Glucose", "Calcium"
        ],
        "Comprehensive Metabolic Panel": [
            "Sodium", "Potassium", "Chloride", "CO2", "BUN", "Creatinine", "Glucose", "Calcium",
            "AST", "ALT", "ALP", "Total Bilirubin", "Albumin", "Total Protein"
        ],
        "Liver Function Tests": [
            "AST", "ALT", "ALP", "Total Bilirubin", "Direct Bilirubin", "Albumin", "Total Protein"
        ],
        "Cardiac Markers": [
            "Troponin I", "Troponin T", "CK-MB", "BNP"
        ]
        // More categories omitted for brevity
    },
    
    // Available imaging studies
    imagingStudies: [
        "Chest X-ray",
        "Abdominal X-ray",
        "Head CT",
        "Chest CT",
        "Abdominal CT"
        // More studies omitted for brevity
    ],
    
    // Common medication categories
    medicationCategories: {
        "Antibiotics": [
            "Amoxicillin", "Azithromycin", "Ceftriaxone", "Ciprofloxacin"
        ],
        "Cardiovascular": [
            "Amlodipine", "Atenolol", "Carvedilol", "Metoprolol", "Nitroglycerin"
        ],
        "Respiratory": [
            "Albuterol", "Budesonide", "Fluticasone", "Ipratropium"
        ]
        // More categories omitted for brevity
    },
    
    // Vital signs normal ranges
    vitalSignRanges: {
        "heartRate": { min: 60, max: 100, unit: "bpm" },
        "bloodPressure": { 
            "systolic": { min: 90, max: 140, unit: "mmHg" },
            "diastolic": { min: 60, max: 90, unit: "mmHg" }
        },
        "meanArterialPressure": { min: 70, max: 100, unit: "mmHg" },
        "respiratoryRate": { min: 12, max: 20, unit: "breaths/min" },
        "temperature": { min: 36.5, max: 37.5, unit: "°C" },
        "oxygenSaturation": { min: 95, max: 100, unit: "%" }
    },
    
    // Available physical exam components
    physicalExamComponents: [
        "General Appearance",
        "HEENT (Head, Eyes, Ears, Nose, Throat)",
        "Neck",
        "Cardiovascular",
        "Pulmonary",
        "Abdominal",
        "Extremities",
        "Neurological",
        "Skin"
    ],
    
    // Available specialist consultations
    consultations: [
        "Cardiology",
        "Pulmonology",
        "Gastroenterology",
        "Neurology",
        "Nephrology",
        "Infectious Disease"
    ],
    
    // Common medication effects on vital signs
    medicationEffects: {
        // Beta blockers
        "Metoprolol": {
            "heartRate": -0.2, // 20% reduction
            "bloodPressure": {
                "systolic": -0.15, // 15% reduction
                "diastolic": -0.1 // 10% reduction
            },
            "doseResponse": true, // Effects are dose-dependent
            "compensatoryMechanisms": {
                "respiratoryRate": 0.05 // Slight increase
            }
        }
        // More medication effects omitted for brevity
    }
};

// API Service for handling API requests
const apiService = {
    apiKey: "sk-e69yagfy1LbeuHU7wUpAIg",
    url: "https://api.ppq.ai/chat/completions",
    model: "claude-3.5-sonnet",
    apiCallCount: 0,
    apiCostPerCall: 0.01, // $0.01 per call
    
    updateApiCost: function() {
        this.apiCallCount++;
        const totalCost = (this.apiCallCount * this.apiCostPerCall).toFixed(2);
        document.getElementById('api-cost').textContent = totalCost;
        console.log(`API call made - new cost: $${totalCost}`);
    },
    
    sendRequest: async function(messages) {
        if (SIMULATION_MODE) {
            // In simulation mode, just return mock data
            this.updateApiCost();
            return this.getMockResponse(messages);
        }
        
        try {
            const headers = {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${this.apiKey}`
            };

            const data = {
                model: this.model,
                messages: messages
            };

            const response = await fetch(this.url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status} ${response.statusText}`);
            }

            // Increment API call count and update cost
            this.updateApiCost();

            const responseData = await response.json();
            return responseData;
        } catch (error) {
            console.error('API Request Error:', error);
            alert(`API Error: ${error.message}. Using simulation mode instead.`);
            // If API fails, fall back to simulation mode
            this.updateApiCost();
            return this.getMockResponse(messages);
        }
    },
    
    getMockResponse: function(messages) {
        // Generate mock data based on the type of request
        const userMessage = messages.find(m => m.role === "user")?.content || "";
        
        if (userMessage.includes("Generate a new patient case")) {
            // Mock patient generation
            const caseType = userMessage.includes("cardiovascular") ? "cardiovascular" : 
                           userMessage.includes("infectious") ? "infectious" :
                           userMessage.includes("emergency") ? "emergency" : "miscellaneous";
            
            return {
                choices: [{
                    message: {
                        content: JSON.stringify({
                            patientInfo: {
                                name: "John Smith",
                                age: 54,
                                gender: "Male",
                                medicalHistory: ["Hypertension", "Type 2 Diabetes", "Smoker (15 pack-years)"],
                                chiefComplaint: caseType === "cardiovascular" ? "Chest pain for 2 hours" :
                                              caseType === "infectious" ? "Fever for 3 days" :
                                              caseType === "emergency" ? "Sudden severe headache" : 
                                              "Fatigue and weight loss for 2 months"
                            },
                            vitalSigns: {
                                heartRate: 95,
                                bloodPressure: {
                                    systolic: 155,
                                    diastolic: 95
                                },
                                respiratoryRate: 18,
                                temperature: 37.2,
                                oxygenSaturation: 96
                            },
                            condition: {
                                name: caseType === "cardiovascular" ? "Acute Coronary Syndrome" :
                                     caseType === "infectious" ? "Community-Acquired Pneumonia" :
                                     caseType === "emergency" ? "Subarachnoid Hemorrhage" : 
                                     "Hypothyroidism",
                                severity: "moderate",
                                duration: "acute"
                            }
                        })
                    }
                }]
            };
        } else if (userMessage.includes("Player action:")) {
            // Mock action response
            const action = userMessage.includes("physical_exam") ? "physical_exam" :
                         userMessage.includes("lab_test") ? "lab_test" :
                         userMessage.includes("medication") ? "medication" :
                         userMessage.includes("imaging") ? "imaging" : "consultation";
            
            return {
                choices: [{
                    message: {
                        content: JSON.stringify({
                            result: {
                                description: `Findings from ${action} action. This is a simulated response.`,
                                interpretation: "Normal findings with some minor abnormalities.",
                                values: {
                                    "Sodium": 138,
                                    "Potassium": 4.2,
                                    "WBC": 9.5
                                }
                            },
                            vitalSignsChange: {
                                heartRate: action === "medication" ? 85 : null,
                                bloodPressure: {
                                    systolic: action === "medication" ? 145 : null,
                                    diastolic: action === "medication" ? 90 : null
                                },
                                respiratoryRate: null,
                                temperature: null,
                                oxygenSaturation: null
                            },
                            conditionChange: {
                                improved: action === "medication",
                                worsened: false,
                                description: action === "medication" ? "Patient's condition is slightly improved." : "No significant change."
                            },
                            scoringImpact: {
                                points: 5,
                                explanation: "Appropriate action for the patient's condition."
                            }
                        })
                    }
                }]
            };
        }
        
        // Default response if none of the above match
        return {
            choices: [{
                message: {
                    content: JSON.stringify({
                        result: {
                            description: "This is a simulated response.",
                            interpretation: "No specific findings.",
                            values: {}
                        },
                        vitalSignsChange: null,
                        conditionChange: {
                            improved: false,
                            worsened: false,
                            description: "No change."
                        },
                        scoringImpact: {
                            points: 0,
                            explanation: "Neutral action."
                        }
                    })
                }
            }]
        };
    },
    
    generatePatient: async function(parameters = {}) {
        console.log("Generating patient with parameters:", parameters);
        
        const systemPrompt = `You are a medical AI that generates realistic patient cases for a medical diagnostic game. Create a patient with a specific ${parameters.caseType || "internal medicine"} condition, including relevant history, physical exam findings, vital signs, and labs that would be consistent with the condition. Format the response as a JSON object.`;

        const userPrompt = `Generate a new patient case with the following parameters: ${JSON.stringify(parameters)}. Make sure all vitals and findings are consistent with the underlying condition but do not make the diagnosis too obvious.`;

        const messages = [
            { role: "system", content: systemPrompt },
            { role: "user", content: userPrompt }
        ];

        const response = await this.sendRequest(messages);
        
        try {
            // Extract JSON from the response
            const responseContent = response.choices[0].message.content;
            const patientData = JSON.parse(responseContent);
            
            // Calculate MAP if not provided
            if (!patientData.vitalSigns.meanArterialPressure && patientData.vitalSigns.bloodPressure) {
                const systolic = patientData.vitalSigns.bloodPressure.systolic;
                const diastolic = patientData.vitalSigns.bloodPressure.diastolic;
                patientData.vitalSigns.meanArterialPressure = Math.round((diastolic * 2 + systolic) / 3);
            }
            
            return patientData;
        } catch (error) {
            console.error('Error parsing patient data:', error);
            throw new Error('Failed to generate patient data');
        }
    },
    
    processAction: async function(patientData, action, actionDetails) {
        console.log("Processing action:", action, "with details:", actionDetails);
        
        const systemPrompt = `You are a medical AI that simulates patient responses to diagnostic and treatment actions in a medical simulation game. Respond with realistic clinical outcomes based on the patient's condition and the action taken. Format your response as a JSON object.`;

        const userPrompt = `Current patient: ${JSON.stringify(patientData)}
        
        Player action: ${action}
        Action details: ${JSON.stringify(actionDetails)}
        
        Provide a realistic response to this action, including any changes to vital signs, condition status, and impact on scoring.`;

        const messages = [
            { role: "system", content: systemPrompt },
            { role: "user", content: userPrompt }
        ];

        const response = await this.sendRequest(messages);
        
        try {
            // Extract JSON from the response
            const responseContent = response.choices[0].message.content;
            const actionResult = JSON.parse(responseContent);
            return actionResult;
        } catch (error) {
            console.error('Error parsing action result:', error);
            throw new Error('Failed to process action');
        }
    }
};

// Physiological Model for predictive drug responses
const physiologicalModel = {
    calculateMedicationEffect: function(medication, details, currentVitals) {
        const effects = gameData.medicationEffects[medication];
        if (!effects) {
            // If medication effects not defined, apply small generic effects
            return {
                heartRate: currentVitals.heartRate - 5,
                bloodPressure: {
                    systolic: currentVitals.bloodPressure.systolic - 5,
                    diastolic: currentVitals.bloodPressure.diastolic - 3
                },
                respiratoryRate: currentVitals.respiratoryRate,
                temperature: currentVitals.temperature,
                oxygenSaturation: currentVitals.oxygenSaturation,
                meanArterialPressure: Math.round(((currentVitals.bloodPressure.diastolic - 3) * 2 + 
                                                  (currentVitals.bloodPressure.systolic - 5)) / 3)
            };
        }
        
        // Get dose multiplier (simplified for this version)
        let doseMultiplier = 1.0;
        
        // Create modified vitals
        let newVitals = {
            heartRate: currentVitals.heartRate,
            bloodPressure: {
                systolic: currentVitals.bloodPressure.systolic,
                diastolic: currentVitals.bloodPressure.diastolic
            },
            respiratoryRate: currentVitals.respiratoryRate,
            temperature: currentVitals.temperature,
            oxygenSaturation: currentVitals.oxygenSaturation
        };
        
        // Apply effects
        if (effects.heartRate) {
            const change = currentVitals.heartRate * effects.heartRate * doseMultiplier;
            newVitals.heartRate = Math.round(currentVitals.heartRate + change);
        }
        
        if (effects.bloodPressure) {
            if (effects.bloodPressure.systolic) {
                const change = currentVitals.bloodPressure.systolic * effects.bloodPressure.systolic * doseMultiplier;
                newVitals.bloodPressure.systolic = Math.round(currentVitals.bloodPressure.systolic + change);
            }
            
            if (effects.bloodPressure.diastolic) {
                const change = currentVitals.bloodPressure.diastolic * effects.bloodPressure.diastolic * doseMultiplier;
                newVitals.bloodPressure.diastolic = Math.round(currentVitals.bloodPressure.diastolic + change);
            }
        }
        
        // Calculate MAP
        newVitals.meanArterialPressure = Math.round((newVitals.bloodPressure.diastolic * 2 + 
                                                     newVitals.bloodPressure.systolic) / 3);
        
        return newVitals;
    }
};

// Patient Manager
const patientManager = {
    data: null,
    vitalHistory: [],
    actionHistory: [],
    isActive: false,
    timeElapsed: 0,
    vitalUpdateInterval: null,
    caseType: "cardiovascular", // Default case type
    
    setCaseType: function(type) {
        this.caseType = type;
        console.log("Case type set to:", type);
    },
    
    async generateNewPatient() {
        try {
            // Clear any existing patient data
            this.resetPatient();
            
            // Generate patient data using API
            this.data = await apiService.generatePatient({ caseType: this.caseType });
            console.log("Patient generated:", this.data);
            
            // Make sure MAP is calculated
            if (!this.data.vitalSigns.meanArterialPressure) {
                const systolic = this.data.vitalSigns.bloodPressure.systolic;
                const diastolic = this.data.vitalSigns.bloodPressure.diastolic;
                this.data.vitalSigns.meanArterialPressure = Math.round((diastolic * 2 + systolic) / 3);
            }
            
            // Record vital signs
            this.recordVitalSigns(this.data.vitalSigns);
            
            // Mark patient as active
            this.isActive = true;
            
            // Start vital signs updates
            this.startVitalSignsUpdates();
            
            return this.data;
        } catch (error) {
            console.error('Error generating patient:', error);
            alert('Error generating patient. Please try again.');
            throw error;
        }
    },
    
    resetPatient: function() {
        this.stopVitalSignsUpdates();
        this.data = null;
        this.vitalHistory = [];
        this.actionHistory = [];
        this.isActive = false;
        this.timeElapsed = 0;
    },
    
    recordVitalSigns: function(vitalSigns) {
        this.vitalHistory.push({
            timestamp: this.timeElapsed,
            vitals: { ...vitalSigns }
        });
    },
    
    startVitalSignsUpdates: function() {
        // Update vitals every 10 seconds
        this.vitalUpdateInterval = setInterval(() => {
            this.updateVitalSigns();
            this.timeElapsed += 10;
        }, 10000);
    },
    
    stopVitalSignsUpdates: function() {
        if (this.vitalUpdateInterval) {
            clearInterval(this.vitalUpdateInterval);
            this.vitalUpdateInterval = null;
        }
    },
    
    updateVitalSigns: function() {
        if (!this.isActive || !this.data) return;
        
        // Get current vitals
        const currentVitals = { ...this.data.vitalSigns };
        
        // Apply small random variations to vitals to simulate natural changes
        currentVitals.heartRate = this.addVariation(currentVitals.heartRate, 5);
        currentVitals.bloodPressure.systolic = this.addVariation(currentVitals.bloodPressure.systolic, 5);
        currentVitals.bloodPressure.diastolic = this.addVariation(currentVitals.bloodPressure.diastolic, 3);
        currentVitals.respiratoryRate = this.addVariation(currentVitals.respiratoryRate, 2);
        currentVitals.temperature = this.addVariation(currentVitals.temperature, 0.2);
        currentVitals.oxygenSaturation = Math.min(100, this.addVariation(currentVitals.oxygenSaturation, 1));
        
        // Calculate MAP
        currentVitals.meanArterialPressure = Math.round((currentVitals.bloodPressure.diastolic * 2 + currentVitals.bloodPressure.systolic) / 3);
        
        // Update the current vitals
        this.data.vitalSigns = currentVitals;
        
        // Record the updated vitals
        this.recordVitalSigns(currentVitals);
        
        // Update UI
        resultsManager.updateVitalSigns(currentVitals);
    },
    
    addVariation: function(value, maxChange) {
        const variation = (Math.random() * 2 - 1) * maxChange;
        return Math.round((value + variation) * 10) / 10;
    },
    
    async processAction(action, details) {
        if (!this.isActive || !this.data) {
            throw new Error('No active patient');
        }
        
        try {
            console.log("Processing action:", action, "with details:", details);
            
            let result;
            
            // For medications, apply physiological model effects
            if (action === 'medication' && details.medication) {
                // Get initial vitals
                const previousVitals = { ...this.data.vitalSigns };
                
                // Calculate medication effects
                const newVitals = physiologicalModel.calculateMedicationEffect(
                    details.medication, 
                    details, 
                    previousVitals
                );
                
                // Process the action using API for description and other effects
                result = await apiService.processAction(this.data, action, details);
                
                // Override the API's vital sign changes with our calculated ones
                if (!result.vitalSignsChange) result.vitalSignsChange = {};
                
                result.vitalSignsChange.heartRate = newVitals.heartRate;
                result.vitalSignsChange.bloodPressure = {
                    systolic: newVitals.bloodPressure.systolic,
                    diastolic: newVitals.bloodPressure.diastolic
                };
                // Keep other vital signs as calculated by API
            } else {
                // For other actions, just use the API
                result = await apiService.processAction(this.data, action, details);
            }
            
            // Record the action
            this.actionHistory.push({
                timestamp: this.timeElapsed,
                action: action,
                details: details,
                result: result
            });
            
            // Update vital signs if there are changes
            if (result.vitalSignsChange) {
                this.applyVitalSignsChanges(result.vitalSignsChange);
            }
            
            // Update patient condition if there are changes
            if (result.conditionChange) {
                this.data.condition.improved = result.conditionChange.improved;
                this.data.condition.worsened = result.conditionChange.worsened;
                if (result.conditionChange.description) {
                    this.data.condition.statusUpdate = result.conditionChange.description;
                }
            }
            
            return result;
        } catch (error) {
            console.error('Error processing action:', error);
            alert('Error processing action. Please try again.');
            throw error;
        }
    },
    
    applyVitalSignsChanges: function(changes) {
        // Only update values that have changed (non-null)
        if (changes.heartRate !== null && changes.heartRate !== undefined) {
            this.data.vitalSigns.heartRate = changes.heartRate;
        }
        
        if (changes.bloodPressure) {
            if (changes.bloodPressure.systolic !== null && changes.bloodPressure.systolic !== undefined) {
                this.data.vitalSigns.bloodPressure.systolic = changes.bloodPressure.systolic;
            }
            if (changes.bloodPressure.diastolic !== null && changes.bloodPressure.diastolic !== undefined) {
                this.data.vitalSigns.bloodPressure.diastolic = changes.bloodPressure.diastolic;
            }
        }
        
        if (changes.respiratoryRate !== null && changes.respiratoryRate !== undefined) {
            this.data.vitalSigns.respiratoryRate = changes.respiratoryRate;
        }
        
        if (changes.temperature !== null && changes.temperature !== undefined) {
            this.data.vitalSigns.temperature = changes.temperature;
        }
        
        if (changes.oxygenSaturation !== null && changes.oxygenSaturation !== undefined) {
            this.data.vitalSigns.oxygenSaturation = changes.oxygenSaturation;
        }
        
        // Calculate MAP from current BP
        this.data.vitalSigns.meanArterialPressure = Math.round(
            (this.data.vitalSigns.bloodPressure.diastolic * 2 + 
            this.data.vitalSigns.bloodPressure.systolic) / 3
        );
        
        // Record the updated vitals
        this.recordVitalSigns(this.data.vitalSigns);
        
        // Update UI
        resultsManager.updateVitalSigns(this.data.vitalSigns);
    }
};

// Results Manager
const resultsManager = {
    updateVitalSigns: function(vitals) {
        // Update heart rate
        const heartRateElement = document.getElementById('heart-rate');
        heartRateElement.textContent = vitals.heartRate;
        this.setVitalSignStyling(
            heartRateElement, 
            vitals.heartRate, 
            gameData.vitalSignRanges.heartRate.min, 
            gameData.vitalSignRanges.heartRate.max
        );
        
        // Update blood pressure
        const bpElement = document.getElementById('blood-pressure');
        const bpText = `${vitals.bloodPressure.systolic}/${vitals.bloodPressure.diastolic}`;
        bpElement.textContent = bpText;
        const systolicNormal = (
            vitals.bloodPressure.systolic >= gameData.vitalSignRanges.bloodPressure.systolic.min && 
            vitals.bloodPressure.systolic <= gameData.vitalSignRanges.bloodPressure.systolic.max
        );
        const diastolicNormal = (
            vitals.bloodPressure.diastolic >= gameData.vitalSignRanges.bloodPressure.diastolic.min && 
            vitals.bloodPressure.diastolic <= gameData.vitalSignRanges.bloodPressure.diastolic.max
        );
        bpElement.className = 'vital-value';
        if (!systolicNormal || !diastolicNormal) {
            bpElement.classList.add(
                vitals.bloodPressure.systolic > gameData.vitalSignRanges.bloodPressure.systolic.max || 
                vitals.bloodPressure.diastolic > gameData.vitalSignRanges.bloodPressure.diastolic.max 
                    ? 'high' : 'low'
            );
        }
        
        // Calculate and update MAP
        const mapElement = document.getElementById('mean-arterial-pressure');
        const map = vitals.meanArterialPressure || 
            Math.round((vitals.bloodPressure.diastolic * 2 + vitals.bloodPressure.systolic) / 3);
        mapElement.textContent = map;
        this.setVitalSignStyling(
            mapElement, 
            map, 
            gameData.vitalSignRanges.meanArterialPressure.min, 
            gameData.vitalSignRanges.meanArterialPressure.max
        );
        
        // Update respiratory rate
        const rrElement = document.getElementById('respiratory-rate');
        rrElement.textContent = vitals.respiratoryRate;
        this.setVitalSignStyling(
            rrElement, 
            vitals.respiratoryRate, 
            gameData.vitalSignRanges.respiratoryRate.min, 
            gameData.vitalSignRanges.respiratoryRate.max
        );
        
        // Update temperature
        const tempElement = document.getElementById('temperature');
        tempElement.textContent = vitals.temperature.toFixed(1);
        this.setVitalSignStyling(
            tempElement, 
            vitals.temperature, 
            gameData.vitalSignRanges.temperature.min, 
            gameData.vitalSignRanges.temperature.max
        );
        
        // Update oxygen saturation
        const o2Element = document.getElementById('oxygen-saturation');
        o2Element.textContent = vitals.oxygenSaturation + '%';
        this.setVitalSignStyling(
            o2Element, 
            vitals.oxygenSaturation, 
            gameData.vitalSignRanges.oxygenSaturation.min, 
            gameData.vitalSignRanges.oxygenSaturation.max
        );
    },
    
    setVitalSignStyling: function(element, value, min, max) {
        // Reset classes
        element.className = 'vital-value';
        
        // Add appropriate class based on value
        if (value < min) {
            element.classList.add('low');
        } else if (value > max) {
            element.classList.add('high');
        }
    },
    
    addResultEntry: function(type, title, content, status = 'info') {
        // Create result entry container
        const entryDiv = document.createElement('div');
        entryDiv.className = `log-entry log-entry-${status}`;
        
        // Add timestamp
        const timestamp = document.createElement('div');
        timestamp.className = 'timestamp';
        timestamp.textContent = this.formatGameTime(patientManager.timeElapsed);
        entryDiv.appendChild(timestamp);
        
        // Add title
        const titleElement = document.createElement('h3');
        titleElement.textContent = `${type}: ${title}`;
        entryDiv.appendChild(titleElement);
        
        // Add content
        const contentElement = document.createElement('div');
        contentElement.className = 'log-content';
        contentElement.innerHTML = content;
        entryDiv.appendChild(contentElement);
        
        // Add to log at the top
        const resultsLogElement = document.getElementById('results-log');
        resultsLogElement.insertBefore(entryDiv, resultsLogElement.firstChild);
    },
    
    addStatusUpdate: function(update, status = 'info') {
        this.addResultEntry('Status Update', 'Patient Condition', `<p>${update}</p>`, status);
    },
    
    addLabResult: function(labName, results) {
        let contentHtml = '<p>Lab results received:</p>';
        let hasAbnormalResults = false;
        
        for (const [test, value] of Object.entries(results)) {
            if (gameData.labRanges[test]) {
                const range = gameData.labRanges[test];
                const isNormal = value >= range.min && value <= range.max;
                if (!isNormal) hasAbnormalResults = true;
                
                contentHtml += `<p>${test}: ${value} ${range.unit} (Normal: ${range.min} - ${range.max})</p>`;
            } else {
                contentHtml += `<p>${test}: ${value}</p>`;
            }
        }
        
        this.addResultEntry('Lab Result', labName, contentHtml, hasAbnormalResults ? 'abnormal' : 'normal');
    },
    
    addExamResult: function(examComponent, result, hasAbnormalFindings) {
        this.addResultEntry(
            'Physical Exam', 
            examComponent, 
            `<p>${result}</p>`, 
            hasAbnormalFindings ? 'abnormal' : 'normal'
        );
    },
    
    addMedicationResponse: function(medication, response, isPositive) {
        this.addResultEntry(
            'Medication', 
            medication, 
            `<p>${response}</p>`, 
            isPositive ? 'normal' : 'abnormal'
        );
    },
    
    addImagingResult: function(imagingType, result, hasFindings) {
        this.addResultEntry(
            'Imaging', 
            imagingType, 
            `<p>${result}</p>`, 
            hasFindings ? 'abnormal' : 'normal'
        );
    },
    
    addConsultationResult: function(specialist, response) {
        this.addResultEntry(
            'Consultation', 
            specialist, 
            `<p>${response}</p>`, 
            'info'
        );
    },
    
    formatGameTime: function(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
    },
    
    clearResults: function() {
        // Clear results log
        document.getElementById('results-log').innerHTML = '';
        
        // Reset vital signs display
        document.getElementById('heart-rate').textContent = '--';
        document.getElementById('blood-pressure').textContent = '--/--';
        document.getElementById('mean-arterial-pressure').textContent = '--';
        document.getElementById('respiratory-rate').textContent = '--';
        document.getElementById('temperature').textContent = '--';
        document.getElementById('oxygen-saturation').textContent = '--';
        
        // Reset classes
        document.getElementById('heart-rate').className = 'vital-value';
        document.getElementById('blood-pressure').className = 'vital-value';
        document.getElementById('mean-arterial-pressure').className = 'vital-value';
        document.getElementById('respiratory-rate').className = 'vital-value';
        document.getElementById('temperature').className = 'vital-value';
        document.getElementById('oxygen-saturation').className = 'vital-value';
    }
};

// Action handlers
const actionsManager = {
    currentAction: null,
    
    selectAction: function(action) {
        console.log("Action selected:", action);
        
        // Remove active class from all buttons
        document.querySelectorAll('.action-btn').forEach(button => {
            button.classList.remove('active');
        });
        
        // Add active class to selected button
        document.getElementById(`${action}-btn`).classList.add('active');
        
        // Set current action
        this.currentAction = action;
        
        // Show appropriate interface
        switch (action) {
            case 'exam':
                this.showExamInterface();
                break;
            case 'labs':
                this.showLabsInterface();
                break;
            case 'drugs':
                this.showDrugsInterface();
                break;
            case 'imaging':
                this.showImagingInterface();
                break;
            case 'consult':
                this.showConsultInterface();
                break;
            default:
                document.getElementById('action-content').innerHTML = '<p>Select an action to continue.</p>';
        }
    },
    
    showExamInterface: function() {
        let html = '<h3>Physical Examination</h3>';
        html += '<p>Select components to examine:</p>';
        
        html += '<div class="action-grid">';
        for (const component of gameData.physicalExamComponents) {
            html += `
                <div class="action-item">
                    <button class="action-option-btn" data-exam="${component}" onclick="actionsManager.performExam('${component}')">
                        ${component}
                    </button>
                </div>
            `;
        }
        html += '</div>';
        
        document.getElementById('action-content').innerHTML = html;
    },
    
    showLabsInterface: function() {
        let html = '<h3>Laboratory Tests</h3>';
        html += '<p>Select tests to order:</p>';
        
        html += '<div class="lab-categories">';
        for (const [category, tests] of Object.entries(gameData.labTests)) {
            html += `
                <div class="lab-category">
                    <h4>${category}</h4>
                    <div class="action-grid">
            `;
            
            for (const test of tests) {
                html += `
                    <div class="action-item">
                        <button class="action-option-btn" onclick="actionsManager.orderLabTest('${test}', '${category}')">
                            ${test}
                        </button>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
        }
        html += '</div>';
        
        document.getElementById('action-content').innerHTML = html;
    },
    
    showDrugsInterface: function() {
        let html = '<h3>Medications</h3>';
        html += '<p>Select medication to administer:</p>';
        
        html += '<div class="medication-categories">';
        for (const [category, medications] of Object.entries(gameData.medicationCategories)) {
            html += `
                <div class="medication-category">
                    <h4>${category}</h4>
                    <div class="action-grid">
            `;
            
            for (const medication of medications) {
                html += `
                    <div class="action-item">
                        <button class="action-option-btn" onclick="actionsManager.showMedicationDosageForm('${medication}', '${category}')">
                            ${medication}
                        </button>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
        }
        html += '</div>';
        
        document.getElementById('action-content').innerHTML = html;
    },
    
    showImagingInterface: function() {
        let html = '<h3>Imaging Studies</h3>';
        html += '<p>Select imaging to order:</p>';
        
        html += '<div class="action-grid">';
        for (const study of gameData.imagingStudies) {
            html += `
                <div class="action-item">
                    <button class="action-option-btn" onclick="actionsManager.orderImaging('${study}')">
                        ${study}
                    </button>
                </div>
            `;
        }
        html += '</div>';
        
        document.getElementById('action-content').innerHTML = html;
    },
    
    showConsultInterface: function() {
        let html = '<h3>Specialist Consultation</h3>';
        html += '<p>Select specialist to consult:</p>';
        
        html += '<div class="action-grid">';
        for (const specialist of gameData.consultations) {
            html += `
                <div class="action-item">
                    <button class="action-option-btn" onclick="actionsManager.requestConsultation('${specialist}')">
                        ${specialist}
                    </button>
                </div>
            `;
        }
        html += '</div>';
        
        document.getElementById('action-content').innerHTML = html;
    },
    
    showMedicationDosageForm: function(medication, category) {
        let html = `<h3>Administer ${medication}</h3>`;
        
        html += `
            <form id="medication-form" onsubmit="event.preventDefault(); actionsManager.administerMedication('${medication}', '${category}');">
                <div class="form-group">
                    <label for="medication-dose">Dose:</label>
                    <input type="text" id="medication-dose" required placeholder="e.g. 5 mg, 500 mcg, 1 g">
                </div>
                <div class="form-group">
                    <label for="medication-route">Route:</label>
                    <select id="medication-route" required>
                        <option value="IV">IV</option>
                        <option value="PO">PO (Oral)</option>
                        <option value="IM">IM</option>
                        <option value="SC">Subcutaneous</option>
                        <option value="Inhaled">Inhaled</option>
                        <option value="Topical">Topical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="medication-frequency">Frequency:</label>
                    <select id="medication-frequency" required>
                        <option value="Once">Once</option>
                        <option value="PRN">PRN (As needed)</option>
                        <option value="Q4H">Q4H (Every 4 hours)</option>
                        <option value="Q6H">Q6H (Every 6 hours)</option>
                        <option value="Q8H">Q8H (Every 8 hours)</option>
                        <option value="Q12H">Q12H (Every 12 hours)</option>
                        <option value="Daily">Daily</option>
                        <option value="BID">BID (Twice daily)</option>
                        <option value="TID">TID (Three times daily)</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="primary-btn">Administer</button>
                    <button type="button" class="secondary-btn" onclick="actionsManager.showDrugsInterface()">Cancel</button>
                </div>
            </form>
        `;
        
        document.getElementById('action-content').innerHTML = html;
    },
    
    async performExam(component) {
        try {
            this.disableButtons();
            
            // Process the exam action
            const result = await patientManager.processAction('physical_exam', { component: component });
            
            // Add result to the results log
            resultsManager.addExamResult(
                component, 
                result.result.description, 
                result.conditionChange && result.conditionChange.worsened
            );
            
            // Update score
            gameManager.updateScore(result.scoringImpact.points, result.scoringImpact.explanation);
            
            this.enableButtons();
        } catch (error) {
            console.error('Error performing exam:', error);
            resultsManager.addStatusUpdate('Error performing examination. Please try again.', 'abnormal');
            this.enableButtons();
        }
    },
    
    async orderLabTest(test, category) {
        try {
            this.disableButtons();
            
            // Process the lab test action
            const result = await patientManager.processAction('lab_test', { 
                test: test,
                category: category
            });
            
            // Add result to the results log
            if (test !== category) {
                // Individual test
                const labResults = {};
                labResults[test] = result.result.values[test] || 'No result';
                resultsManager.addLabResult(test, labResults);
            } else {
                // Panel test
                resultsManager.addLabResult(category, result.result.values);
            }
            
            // Update score
            gameManager.updateScore(result.scoringImpact.points, result.scoringImpact.explanation);
            
            this.enableButtons();
        } catch (error) {
            console.error('Error ordering lab test:', error);
            resultsManager.addStatusUpdate('Error ordering laboratory test. Please try again.', 'abnormal');
            this.enableButtons();
        }
    },
    
    async administerMedication(medication, category) {
        try {
            this.disableButtons();
            
            const dose = document.getElementById('medication-dose').value;
            const route = document.getElementById('medication-route').value;
            const frequency = document.getElementById('medication-frequency').value;
            
            // Process the medication action
            const result = await patientManager.processAction('medication', {
                medication: medication,
                category: category,
                dose: dose,
                route: route,
                frequency: frequency
            });
            
            // Add result to the results log
            resultsManager.addMedicationResponse(
                `${medication} ${dose} ${route} ${frequency}`,
                result.result.description,
                !result.conditionChange.worsened
            );
            
            // Update score
            gameManager.updateScore(result.scoringImpact.points, result.scoringImpact.explanation);
            
            // Return to medications interface
            this.showDrugsInterface();
            
            this.enableButtons();
        } catch (error) {
            console.error('Error administering medication:', error);
            resultsManager.addStatusUpdate('Error administering medication. Please try again.', 'abnormal');
            this.enableButtons();
        }
    },
    
    async orderImaging(imaging) {
        try {
            this.disableButtons();
            
            // Process the imaging action
            const result = await patientManager.processAction('imaging', { study: imaging });
            
            // Add result to the results log
            resultsManager.addImagingResult(
                imaging,
                result.result.description,
                result.result.interpretation && result.result.interpretation.includes('abnormal')
            );
            
            // Update score
            gameManager.updateScore(result.scoringImpact.points, result.scoringImpact.explanation);
            
            this.enableButtons();
        } catch (error) {
            console.error('Error ordering imaging:', error);
            resultsManager.addStatusUpdate('Error ordering imaging study. Please try again.', 'abnormal');
            this.enableButtons();
        }
    },
    
    async requestConsultation(specialist) {
        try {
            this.disableButtons();
            
            // Process the consultation action
            const result = await patientManager.processAction('consultation', { specialist: specialist });
            
            // Add result to the results log
            resultsManager.addConsultationResult(specialist, result.result.description);
            
            // Update score
            gameManager.updateScore(result.scoringImpact.points, result.scoringImpact.explanation);
            
            this.enableButtons();
        } catch (error) {
            console.error('Error requesting consultation:', error);
            resultsManager.addStatusUpdate('Error requesting consultation. Please try again.', 'abnormal');
            this.enableButtons();
        }
    },
    
    disableButtons: function() {
        document.querySelectorAll('#action-content button').forEach(button => {
            button.disabled = true;
            button.classList.add('disabled');
        });
    },
    
    enableButtons: function() {
        document.querySelectorAll('#action-content button').forEach(button => {
            button.disabled = false;
            button.classList.remove('disabled');
        });
    },
    
    reset: function() {
        this.currentAction = null;
        document.querySelectorAll('.action-btn').forEach(button => {
            button.classList.remove('active');
        });
        document.getElementById('action-content').innerHTML = '<p>Select an action to begin.</p>';
    }
};

// Game Manager
const gameManager = {
    score: 0,
    gameTimer: null,
    gameTime: 0,
    
    start: function() {
        console.log("Starting game...");
        resultsManager.addStatusUpdate('Welcome to Vital Decisions: Resident\'s Challenge! Select a case type and click "New Patient" to begin a new case.', 'info');
        this.updateScore(0, 'Game started');
    },
    
    async startNewCase() {
        try {
            console.log("Starting new case...");
            
            // Show loading indicator
            document.getElementById('patient-info').innerHTML = '<p>Generating new patient case...</p>';
            resultsManager.clearResults();
            actionsManager.reset();
            
            // Reset score
            this.score = 0;
            this.updateScore(0, 'New case started');
            
            // Reset game time
            this.resetGameTime();
            
            // Generate new patient
            const patient = await patientManager.generateNewPatient();
            
            // Display patient info
            this.displayPatientInfo(patient);
            
            // Start game timer
            this.startGameTimer();
            
            // Add initial status update
            resultsManager.addStatusUpdate('New patient case started. Perform examination and tests to diagnose and treat.', 'info');
            
            // Display initial vital signs
            resultsManager.updateVitalSigns(patient.vitalSigns);
        } catch (error) {
            console.error('Error starting new case:', error);
            resultsManager.addStatusUpdate('Error generating patient case. Please try again.', 'abnormal');
        }
    },
    
    displayPatientInfo: function(patient) {
        let html = `<h3>${patient.patientInfo.name}</h3>`;
        html += `<p><strong>Age:</strong> ${patient.patientInfo.age} | <strong>Gender:</strong> ${patient.patientInfo.gender}</p>`;
        html += `<p><strong>Chief Complaint:</strong> "${patient.patientInfo.chiefComplaint}"</p>`;
        
        html += '<h4>Medical History</h4>';
        html += '<ul>';
        for (const item of patient.patientInfo.medicalHistory) {
            html += `<li>${item}</li>`;
        }
        html += '</ul>';
        
        document.getElementById('patient-info').innerHTML = html;
    },
    
    startGameTimer: function() {
        // Clear existing timer if any
        if (this.gameTimer) {
            clearInterval(this.gameTimer);
        }
        
        // Reset game time
        this.gameTime = 0;
        this.updateGameTimeDisplay();
        
        // Start timer that updates every second
        this.gameTimer = setInterval(() => {
            this.gameTime++;
            this.updateGameTimeDisplay();
        }, 1000);
    },
    
    resetGameTime: function() {
        if (this.gameTimer) {
            clearInterval(this.gameTimer);
            this.gameTimer = null;
        }
        this.gameTime = 0;
        this.updateGameTimeDisplay();
    },
    
    updateGameTimeDisplay: function() {
        const minutes = Math.floor(this.gameTime / 60);
        const seconds = this.gameTime % 60;
        document.getElementById('game-time').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    },
    
    updateScore: function(points, reason) {
        this.score += points;
        document.getElementById('score').textContent = this.score;
        
        // Log score changes
        if (points < 0) {
            resultsManager.addStatusUpdate(`Score penalty: ${points} points - ${reason}`, 'abnormal');
        } else if (points > 0) {
            resultsManager.addStatusUpdate(`Score award: +${points} points - ${reason}`, 'normal');
        }
    }
};

// Initialize the game when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM fully loaded - initializing game...");
    
    // Set up case type button click handlers
    document.querySelectorAll('.case-type-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Get the case type from the button ID
            const caseType = this.id.replace('case-', '');
            console.log("Case type selected:", caseType);
            
            // Remove active class from all buttons
            document.querySelectorAll('.case-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to this button
            this.classList.add('active');
            
            // Set case type
            patientManager.setCaseType(caseType);
        });
    });
    
    // Set up new patient button click handler
    document.getElementById('new-patient-btn').addEventListener('click', function() {
        console.log("New patient button clicked");
        gameManager.startNewCase();
    });
    
    // Set up action button click handlers
    document.querySelectorAll('.action-btn').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.id.replace('-btn', '');
            console.log("Action button clicked:", action);
            actionsManager.selectAction(action);
        });
    });
    
    // Start the game
    gameManager.start();
    
    console.log("Game initialized successfully");
});
</script>
</body>
</html>
